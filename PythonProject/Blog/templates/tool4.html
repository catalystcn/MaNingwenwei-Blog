<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³ä¹æ’­æ”¾å™¨</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="./static/ajax.js"></script>
    <script src="./static/cursor_click.js"></script>
</head>
<body>
    <div class="navbar">
        <a href="{{ url_for('index') }}">ä¸»é¡µ</a>
        <a href="{{ url_for('toolbox') }}">å·¥å…·ç®±</a>
    </div>
    <div class="container">
        <h1>ğŸŒˆéŸ³ä¹æ’­æ”¾å™¨</h1>
        <div class="greyLine" style="color:green">ä½ æƒ³å¬å“ªä½æ­Œæ‰‹çš„æ­Œå‘¢ï¼Ÿ</div>
        <input type="text" id="singerName" placeholder="è¯·è¾“å…¥æ­Œæ‰‹å">
        <button onclick="searchSongs()">æœç´¢</button>
        <div id="songList"></div>
        <div class="pagination-container">
            <button id="firstPageBtn" class="pagination-btn" style="display: none;" onclick="firstPage()">å‰10é¦–</button>
            <button id="nextPageBtn" class="pagination-btn" style="display: none;" onclick="nextPage()">å10é¦–</button>
        </div>
    </div>

    <!-- Floating Player -->
    <div id="floating-player">
        <div class="song-info">
            <img id="floating-cover" src="" alt="Cover">
            <div id="floating-title"></div>
            <button id="play-pause-btn" >æš‚åœ</button>
        </div>
        <div class="progress-bar">
            <div id="floating-progress" class="progress"></div>
        </div>
    </div>

    <!-- Hidden popup -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <p>è¯¥æ­Œæ›²å› ç‰ˆæƒé™åˆ¶ï¼Œæ— æ³•æ’­æ”¾</p>
            <button id="closeModalBtn">å…³é—­</button>
        </div>
    </div>

    <div id="errorModal" class="modal">
        <div class="modal-content">
            <p id="errorMessage"></p>
            <button id="closeErrorModalBtn">å…³é—­</button>
        </div>
    </div>

    <script>

        var currentPage = 0;
        var songs = [];
        var audio = new Audio();

    // Function to show error modal
        function showErrorModal(message) {
            document.getElementById('errorMessage').textContent = message;
            $('#errorModal').show();
        }

        // Close error modal when "å…³é—­" button is clicked
        $('#closeErrorModalBtn').click(function() {
            $('#errorModal').hide();
        });

        function searchSongs() {
            currentPage = 0;
            var singerName = document.getElementById('singerName').value;
            getSongs(singerName);
        }

        function getSongs(singerName) {
            // Make AJAX request to server to get song list
            var xhr = new XMLHttpRequest();
            xhr.open('GET', '/search?singer=' + encodeURIComponent(singerName), true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        console.error('æ‰¾åˆ°æ­Œæ›²')
                        songs = JSON.parse(xhr.responseText);
                        displaySongs();
                        checkCurrentPageSongs();
                    } else if (xhr.status === 404) {
                        showErrorModal('æœç´¢æ— ç»“æœï¼Œè¯·æ£€æŸ¥æ­Œæ‰‹åæ˜¯å¦æ­£ç¡®');
                    } else {
                        showErrorModal('å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•ï¼');
                    }
                }
            };
            xhr.send();
        }

        function checkCurrentPageSongs() {
            // æ£€æŸ¥å½“å‰é¡µé¢çš„æ­Œæ›²æ˜¯å¦å¯æ’­æ”¾
            var songListContainer = document.getElementById('songList');
            var songItems = songListContainer.getElementsByClassName('song-item');

            Array.from(songItems).forEach(function(songItem, index) {
                var song = songs[currentPage * 10 + index];
                var audioCheck = new Audio();
                audioCheck.src = song.song_url;
                audioCheck.onerror = function() {
                    var title = songItem.querySelector('span');
                    title.textContent += 'ã€ç‰ˆæƒé™åˆ¶ã€‘';
                    title.style.color = 'red';
                };
            });
        }

        function displaySongs() {
            var songListContainer = document.getElementById('songList');
            songListContainer.innerHTML = '';

            var endIndex = Math.min((currentPage + 1) * 10, songs.length);

            for (var i = currentPage * 10; i < endIndex; i++) {
                var song = songs[i];
                var songItem = document.createElement('div');
                songItem.classList.add('song-item');

                var img = document.createElement('img');
                img.src = song.song_cover;
                songItem.appendChild(img);

                var title = document.createElement('span');
                title.textContent = song.song_name;
                songItem.appendChild(title);

                var playBtn = document.createElement('button');
                playBtn.classList.add('play-btn');
                playBtn.textContent = 'æ’­æ”¾';

                // åˆ›å»ºé—­åŒ…ä»¥æ•è·å½“å‰çš„æ­Œæ›²
                (function(currentSong) {
                    playBtn.addEventListener('click', function() {
                        playSong(currentSong.song_url, currentSong.song_cover, currentSong.song_name);
                    });
                })(song);

                songItem.appendChild(playBtn);

                songListContainer.appendChild(songItem);
            }

            // æ ¹æ®å½“å‰é¡µé¢çš„ä½ç½®æ˜¾ç¤ºæˆ–éšè—ä¸Šä¸€é¡µå’Œä¸‹ä¸€é¡µæŒ‰é’®
            if (endIndex < songs.length) {
                document.getElementById('nextPageBtn').style.display = 'inline-block';
                if (currentPage != 0) {
                    document.getElementById('firstPageBtn').style.display = 'inline-block';
                } else {
                    document.getElementById('firstPageBtn').style.display = 'none';
                }
            } else {
                document.getElementById('nextPageBtn').style.display = 'none';
            }
        }

        function playSong(songUrl, coverUrl, title) {
            audio.onerror = function() {
                // å½“æ­Œæ›²æ— æ³•æ’­æ”¾æ—¶ï¼Œè§¦å‘onerroräº‹ä»¶
                var songTitle = document.querySelector('span:contains("' + title + '")');
                songTitle.style.color = 'red'; // å°†æ­Œæ›²åç§°æ ‡è®°ä¸ºçº¢è‰²
                songTitle.textContent += 'ï¼ˆç‰ˆæƒé™åˆ¶ï¼‰'; // æ·»åŠ ç‰ˆæƒé™åˆ¶æ ‡è®°
            };

            audio.onerror = function() {
                $('#myModal').show();
            };

            // Show floating player
            var floatingPlayer = document.getElementById('floating-player');
            floatingPlayer.style.display = 'block';

            audio.src = songUrl;
            audio.play();

            // Update floating player
            document.getElementById('floating-cover').src = coverUrl;
            document.getElementById('floating-title').textContent = title;

            // Show floating player
            document.getElementById('floating-player').style.display = 'block';

            // Play/Pause button
            var playPauseBtn = document.getElementById('play-pause-btn');
            playPauseBtn.textContent = 'æš‚åœ';
            playPauseBtn.onclick = function () {
                if (audio.paused) {
                    audio.play();
                    playPauseBtn.textContent = 'æš‚åœ';
                } else {
                    audio.pause();
                    playPauseBtn.textContent = 'æ’­æ”¾';
                }
            };

            // Progress bar
            var progress = document.getElementById('floating-progress');
            audio.addEventListener('timeupdate', function () {
                var percent = (audio.currentTime / audio.duration) * 100;
                progress.style.width = percent + '%';
            });

            // Drag progress
            var progressBar = document.querySelector('#floating-player .progress-bar');
            progressBar.addEventListener('click', function (event) {
                var boundingRect = progressBar.getBoundingClientRect();
                var offsetX = event.clientX - boundingRect.left;
                var percent = offsetX / progressBar.clientWidth;
                audio.currentTime = percent * audio.duration;
            });
        }

        // Close modal when "å…³é—­" button is clicked
        $('#closeModalBtn').click(function() {
            $('#myModal').hide();
        });

        function nextPage() {
            currentPage++;
            displaySongs();
            checkCurrentPageSongs();
        }

        function firstPage() {
            if (currentPage > 0) {
                currentPage = currentPage - 1;
            }
            displaySongs();
            checkCurrentPageSongs();
        }
    </script>
</body>
</html>
